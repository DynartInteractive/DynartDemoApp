<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Dashboard - DynartDemoApp</title>

    <!-- Ionic Framework CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />

    <style>
        ion-app {
            --ion-background-color: #f4f5f8;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .error {
            color: var(--ion-color-danger);
            padding: 20px;
            text-align: center;
        }

        .user-card {
            margin-bottom: 12px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .permission-item {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <ion-app x-data="app()" x-init="init()">
        <ion-header>
            <ion-toolbar color="primary">
                <ion-title>Dashboard</ion-title>
                <ion-buttons slot="end">
                    <ion-button @click="navigate('/')">
                        <ion-icon name="home"></ion-icon>
                        Dashboard
                    </ion-button>
                    <ion-button @click="navigate('/users')">
                        <ion-icon name="people"></ion-icon>
                        Users
                    </ion-button>
                    <ion-button @click="logout()">
                        <ion-icon name="log-out"></ion-icon>
                        Logout
                    </ion-button>
                </ion-buttons>
            </ion-toolbar>
        </ion-header>

        <ion-content>
            <div class="container">
                <!-- Dashboard View -->
                <div x-show="currentView === 'dashboard'">
                    <ion-card>
                        <ion-card-header>
                            <ion-card-title>Your Permissions</ion-card-title>
                        </ion-card-header>
                        <ion-card-content>
                            <!-- Loading State -->
                            <div x-show="loadingPermissions" class="loading">
                                <ion-spinner></ion-spinner>
                                <p>Loading permissions...</p>
                            </div>

                            <!-- Permissions List -->
                            <div x-show="!loadingPermissions">
                                <template x-if="permissions.length > 0">
                                    <ion-list>
                                        <template x-for="permission in permissions" :key="permission">
                                            <ion-item class="permission-item">
                                                <ion-icon name="checkmark-circle" slot="start" color="success"></ion-icon>
                                                <ion-label x-text="permission"></ion-label>
                                            </ion-item>
                                        </template>
                                    </ion-list>
                                </template>
                                <template x-if="permissions.length === 0">
                                    <p>No permissions assigned</p>
                                </template>
                            </div>
                        </ion-card-content>
                    </ion-card>
                </div>

                <!-- User List View -->
                <div x-show="currentView === 'users'">
                    <ion-card>
                        <ion-card-header>
                            <ion-card-title>Users</ion-card-title>
                        </ion-card-header>
                        <ion-card-content>
                            <!-- Search Bar -->
                            <ion-searchbar
                                placeholder="Search users..."
                                x-model="searchQuery"
                                @ionInput="searchQuery = $event.target.value">
                            </ion-searchbar>

                            <!-- Filter by Role -->
                            <ion-item>
                                <ion-label>Filter by Role</ion-label>
                                <ion-select x-model="roleFilter" @ionChange="roleFilter = $event.target.value">
                                    <ion-select-option value="">All Roles</ion-select-option>
                                    <ion-select-option value="Admin">Admin</ion-select-option>
                                    <ion-select-option value="User">User</ion-select-option>
                                </ion-select>
                            </ion-item>

                            <!-- Loading State -->
                            <div x-show="loading" class="loading">
                                <ion-spinner></ion-spinner>
                                <p>Loading users...</p>
                            </div>

                            <!-- Error State -->
                            <div x-show="error" class="error" x-text="error"></div>

                            <!-- User List -->
                            <div x-show="!loading && !error">
                                <template x-for="user in filteredUsers" :key="user.id">
                                    <ion-card class="user-card">
                                        <ion-card-header>
                                            <ion-card-title x-text="user.displayName"></ion-card-title>
                                            <ion-card-subtitle x-text="user.email"></ion-card-subtitle>
                                        </ion-card-header>
                                        <ion-card-content>
                                            <ion-badge :color="user.role === 'Admin' ? 'primary' : 'secondary'" x-text="user.role"></ion-badge>
                                            <p x-text="`Joined: ${new Date(user.createdAt).toLocaleDateString()}`"></p>
                                            <p x-show="user.updatedAt" x-text="`Updated: ${new Date(user.updatedAt).toLocaleDateString()}`"></p>

                                            <div class="user-actions">
                                                <ion-button size="small" @click="navigate('/users/edit/' + user.id)">
                                                    <ion-icon slot="start" name="create"></ion-icon>
                                                    Edit
                                                </ion-button>
                                                <ion-button size="small" color="danger" @click="confirmDelete(user)">
                                                    <ion-icon slot="start" name="trash"></ion-icon>
                                                    Delete
                                                </ion-button>
                                            </div>
                                        </ion-card-content>
                                    </ion-card>
                                </template>

                                <!-- No Results -->
                                <div x-show="filteredUsers.length === 0" style="text-align: center; padding: 40px;">
                                    <ion-icon name="people-outline" style="font-size: 64px; color: #ccc;"></ion-icon>
                                    <p>No users found</p>
                                </div>
                            </div>
                        </ion-card-content>
                    </ion-card>
                </div>

                <!-- User Edit View -->
                <div x-show="currentView === 'edit'">
                    <ion-card>
                        <ion-card-header>
                            <ion-card-title x-text="editingUser.id ? 'Edit User' : 'New User'"></ion-card-title>
                        </ion-card-header>
                        <ion-card-content>
                            <!-- Loading State -->
                            <div x-show="loading" class="loading">
                                <ion-spinner></ion-spinner>
                            </div>

                            <!-- Edit Form -->
                            <form x-show="!loading" @submit.prevent="saveUser()">
                                <ion-item>
                                    <ion-label position="stacked">Display Name *</ion-label>
                                    <ion-input
                                        type="text"
                                        x-model="editingUser.displayName"
                                        required
                                        placeholder="Enter display name">
                                    </ion-input>
                                </ion-item>

                                <ion-item>
                                    <ion-label position="stacked">Email *</ion-label>
                                    <ion-input
                                        type="email"
                                        x-model="editingUser.email"
                                        required
                                        placeholder="Enter email">
                                    </ion-input>
                                </ion-item>

                                <ion-item>
                                    <ion-label position="stacked">Role</ion-label>
                                    <ion-select x-model="editingUser.role">
                                        <ion-select-option value="User">User</ion-select-option>
                                        <ion-select-option value="Admin">Admin</ion-select-option>
                                    </ion-select>
                                </ion-item>

                                <!-- Error Message -->
                                <div x-show="error" class="error" x-text="error"></div>

                                <!-- Action Buttons -->
                                <div style="margin-top: 20px; display: flex; gap: 12px;">
                                    <ion-button type="submit" expand="block" :disabled="saving">
                                        <ion-spinner x-show="saving" slot="start"></ion-spinner>
                                        <span x-text="saving ? 'Saving...' : 'Save'"></span>
                                    </ion-button>
                                    <ion-button type="button" color="medium" expand="block" @click="navigate('/users')">
                                        Cancel
                                    </ion-button>
                                </div>
                            </form>
                        </ion-card-content>
                    </ion-card>
                </div>
            </div>
        </ion-content>

        <!-- Delete Confirmation Modal -->
        <ion-alert
            :is-open="showDeleteConfirm"
            header="Delete User"
            :message="`Are you sure you want to delete ${userToDelete?.displayName}?`"
            :buttons="[
                { text: 'Cancel', role: 'cancel', handler: () => showDeleteConfirm = false },
                { text: 'Delete', role: 'destructive', handler: () => deleteUser() }
            ]"
        ></ion-alert>
    </ion-app>

    <!-- Ionic Framework Core -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Navigo Router -->
    <script src="https://cdn.jsdelivr.net/npm/navigo@8.11.1/lib/navigo.min.js"></script>

    <script>
        function app() {
            return {
                // State
                currentView: 'dashboard',
                users: [],
                permissions: [],
                searchQuery: '',
                roleFilter: '',
                loading: false,
                loadingPermissions: false,
                saving: false,
                error: null,
                editingUser: {},
                showDeleteConfirm: false,
                userToDelete: null,
                router: null,

                // Computed - Filtered Users
                get filteredUsers() {
                    return this.users.filter(user => {
                        const matchesSearch = user.displayName.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                                            user.email.toLowerCase().includes(this.searchQuery.toLowerCase());
                        const matchesRole = !this.roleFilter || user.role === this.roleFilter;
                        return matchesSearch && matchesRole;
                    });
                },

                // Initialize
                init() {
                    this.setupRouter();
                    this.checkAuth();
                },

                // Check authentication
                async checkAuth() {
                    try {
                        const response = await fetch('/api/permissions');
                        if (!response.ok) {
                            window.location.href = '/';
                        }
                    } catch (err) {
                        window.location.href = '/';
                    }
                },

                // Setup Navigo Router
                setupRouter() {
                    this.router = new Navigo('/');

                    this.router
                        .on('/', () => {
                            this.showDashboard();
                        })
                        .on('/users', () => {
                            this.showUserList();
                        })
                        .on('/users/edit/:id', ({ data }) => {
                            this.showUserEdit(data.id);
                        })
                        .on('/users/new', () => {
                            this.showUserEdit(null);
                        })
                        .resolve();
                },

                // Navigate
                navigate(path) {
                    this.router.navigate(path);
                },

                // Show Dashboard
                async showDashboard() {
                    this.currentView = 'dashboard';
                    this.error = null;
                    await this.loadPermissions();
                },

                // Load Permissions
                async loadPermissions() {
                    this.loadingPermissions = true;

                    try {
                        const response = await fetch('/api/permissions');
                        if (!response.ok) {
                            window.location.href = '/';
                            return;
                        }
                        const data = await response.json();
                        this.permissions = data.permissions || [];
                    } catch (err) {
                        console.error('Error loading permissions:', err);
                        window.location.href = '/';
                    } finally {
                        this.loadingPermissions = false;
                    }
                },

                // Show User List
                async showUserList() {
                    this.currentView = 'users';
                    this.error = null;
                    await this.loadUsers();
                },

                // Load Users from API
                async loadUsers() {
                    this.loading = true;
                    this.error = null;

                    try {
                        const response = await fetch('/api/users');
                        if (!response.ok) throw new Error('Failed to load users');
                        this.users = await response.json();
                    } catch (err) {
                        this.error = err.message;
                    } finally {
                        this.loading = false;
                    }
                },

                // Show User Edit
                async showUserEdit(userId) {
                    this.currentView = 'edit';
                    this.error = null;

                    if (userId) {
                        this.loading = true;
                        try {
                            const response = await fetch(`/api/users/${userId}`);
                            if (!response.ok) throw new Error('Failed to load user');
                            this.editingUser = await response.json();
                        } catch (err) {
                            this.error = err.message;
                        } finally {
                            this.loading = false;
                        }
                    } else {
                        this.editingUser = { displayName: '', email: '', role: 'User' };
                    }
                },

                // Save User
                async saveUser() {
                    this.saving = true;
                    this.error = null;

                    try {
                        const url = this.editingUser.id
                            ? `/api/users/${this.editingUser.id}`
                            : '/api/users';
                        const method = this.editingUser.id ? 'PUT' : 'POST';

                        const response = await fetch(url, {
                            method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.editingUser)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Failed to save user');
                        }

                        this.navigate('/users');
                    } catch (err) {
                        this.error = err.message;
                    } finally {
                        this.saving = false;
                    }
                },

                // Confirm Delete
                confirmDelete(user) {
                    this.userToDelete = user;
                    this.showDeleteConfirm = true;
                },

                // Delete User
                async deleteUser() {
                    if (!this.userToDelete) return;

                    try {
                        const response = await fetch(`/api/users/${this.userToDelete.id}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) throw new Error('Failed to delete user');

                        await this.loadUsers();
                    } catch (err) {
                        this.error = err.message;
                    } finally {
                        this.showDeleteConfirm = false;
                        this.userToDelete = null;
                    }
                },

                // Logout
                async logout() {
                    window.location.href = '/api/logout';
                }
            };
        }
    </script>
</body>
</html>
